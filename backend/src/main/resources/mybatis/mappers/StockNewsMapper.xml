<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.boot.dao.StockNewsDAO">

    <!-- Ï¢ÖÎ™©Î≥Ñ Îâ¥Ïä§ Î¶¨Ïä§Ìä∏ -->
    <select id="getNewsByStock" parameterType="string" resultType="com.boot.dto.StockNewsDTO">
        SELECT NEWS_ID, STOCK_CODE, TITLE,CONTENT, URL,NEWS_DATE, CREATED_AT,
        	   SENTIMENT, SCORE, KEYWORDS, UPDATED_AT
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
        ORDER BY NEWS_DATE DESC
    </select>

    <!-- Í∞êÏÑ± ÏöîÏïΩ -->
    <select id="getSentimentSummary" parameterType="string" resultType="map">
        SELECT
            SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
    </select>

    <!-- Ï¢ÖÎ™©Î≥Ñ Í∞êÏÑ± ÌÜµÍ≥Ñ (ÏÉÅÏÑ∏) -->
    <select id="getSentimentSummaryByStock" parameterType="string" resultType="map">
        SELECT 
            STOCK_CODE,
            COUNT(*) AS totalNews,
            SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS positiveRatio,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS negativeRatio,
            ROUND(AVG(SCORE), 2) AS avgScore
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
          AND SENTIMENT IS NOT NULL
        GROUP BY STOCK_CODE
    </select>

    <!-- Ï¢ÖÎ™©Î≥Ñ Í∞êÏÑ± ÌÜµÍ≥Ñ (Í∏∞Í∞Ñ ÌïÑÌÑ∞ÎßÅ) -->
    <select id="getSentimentSummaryByStockWithPeriod" resultType="map">
        SELECT 
            STOCK_CODE,
            COUNT(*) AS totalNews,
            SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS positiveRatio,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS negativeRatio,
            ROUND(AVG(SCORE), 2) AS avgScore
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
          AND SENTIMENT IS NOT NULL
          AND NEWS_DATE >= SYSDATE - #{days}
        GROUP BY STOCK_CODE
    </select>

    <!-- Ï†ÑÏ≤¥ Ï¢ÖÎ™©Î≥Ñ Í∞êÏÑ± ÌÜµÍ≥Ñ (ÎåÄÏãúÎ≥¥ÎìúÏö©) -->
    <select id="getAllStockSentimentSummary" resultType="map">
        SELECT 
            STOCK_CODE,
            COUNT(*) AS totalNews,
            SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS positiveRatio,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS negativeRatio,
            ROUND(AVG(SCORE), 2) AS avgScore
        FROM STOCK_NEWS
        WHERE SENTIMENT IS NOT NULL
          AND STOCK_CODE IS NOT NULL
        GROUP BY STOCK_CODE
        ORDER BY totalNews DESC
    </select>

    <!-- Ï†ÑÏ≤¥ Ï¢ÖÎ™©Î≥Ñ Í∞êÏÑ± ÌÜµÍ≥Ñ (Í∏∞Í∞Ñ ÌïÑÌÑ∞ÎßÅ) -->
    <select id="getAllStockSentimentSummaryWithPeriod" resultType="map">
        SELECT 
            STOCK_CODE,
            COUNT(*) AS totalNews,
            SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS positiveRatio,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS negativeRatio,
            ROUND(AVG(SCORE), 2) AS avgScore
        FROM STOCK_NEWS
        WHERE SENTIMENT IS NOT NULL
          AND STOCK_CODE IS NOT NULL
          AND NEWS_DATE >= SYSDATE - #{days}
        GROUP BY STOCK_CODE
        ORDER BY totalNews DESC
    </select>

    <!-- Ï¢ÖÎ™©Î≥Ñ ÎÇ†ÏßúÎ≥Ñ Í∞êÏÑ± ÌÜµÍ≥Ñ (Ìä∏Î†åÎìú) -->
    <select id="getSentimentTrendByStock" resultType="map">
        SELECT 
            TO_CHAR(NEWS_DATE, 'YYYY-MM-DD') AS newsDate,
            COUNT(*) AS totalNews,
            SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount,
            ROUND(AVG(SCORE), 2) AS avgScore
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
          AND SENTIMENT IS NOT NULL
          AND NEWS_DATE >= SYSDATE - #{days}
        GROUP BY TO_CHAR(NEWS_DATE, 'YYYY-MM-DD')
        ORDER BY newsDate DESC
    </select>

    <!-- ÌÇ§ÏõåÎìú TOP 10 (ÌäπÏ†ï Ï¢ÖÎ™©) - KEYWORDSÎßå Ï°∞Ìöå -->
    <select id="getTopKeywordsByStock" parameterType="string" resultType="map">
        SELECT KEYWORDS
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
          AND KEYWORDS IS NOT NULL
          AND LENGTH(TRIM(KEYWORDS)) > 0
    </select>

    <!-- Ï†ÑÏ≤¥ ÌÇ§ÏõåÎìú TOP 20 (Ìä∏Î†åÎìú) - KEYWORDSÎßå Ï°∞Ìöå -->
    <select id="getTopKeywordsAll" resultType="map">
        SELECT KEYWORDS
        FROM STOCK_NEWS
        WHERE KEYWORDS IS NOT NULL
          AND LENGTH(TRIM(KEYWORDS)) > 0
          AND NEWS_DATE >= SYSDATE - #{days}
    </select>

    <!-- Ï†ÑÏ≤¥ Í∞êÏÑ± ÌÜµÍ≥Ñ -->
    <select id="getOverallSentimentSummary" resultType="map">
        SELECT 
            COUNT(*) AS totalNews,
            SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS positiveRatio,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS negativeRatio,
            ROUND(SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS neutralRatio,
            ROUND(AVG(SCORE), 2) AS avgScore
        FROM STOCK_NEWS
        WHERE SENTIMENT IS NOT NULL
    </select>
    
    <!-- ‚úÖ ÏÇ∞ÏóÖ Î™©Î°ù Ï°∞Ìöå -->
	<select id="getIndustries" resultType="string">
	    SELECT DISTINCT INDUSTRY
	    FROM STOCK_INDUSTRY
	    ORDER BY INDUSTRY
	</select>
	
	<!-- ‚úÖ ÏÇ∞ÏóÖÎ≥Ñ Îâ¥Ïä§ Ï°∞Ìöå -->
	<select id="getNewsByIndustry" resultType="com.boot.dto.StockNewsDTO">
	    SELECT n.*
	    FROM STOCK_NEWS n
	    JOIN STOCK_INDUSTRY i
	      ON n.STOCK_CODE = i.STOCK_CODE
	    WHERE i.INDUSTRY = #{industry}
	    ORDER BY n.NEWS_DATE DESC
	</select>

    <!-- ‚úÖ ÌÇ§ÏõåÎìúÎ≥Ñ Îâ¥Ïä§ Ï°∞Ìöå -->
    <select id="getNewsByKeyword" resultType="com.boot.dto.StockNewsDTO">
        SELECT NEWS_ID, STOCK_CODE, TITLE, CONTENT, URL, NEWS_DATE, CREATED_AT,
               SENTIMENT, SCORE, KEYWORDS, UPDATED_AT
        FROM STOCK_NEWS
        WHERE KEYWORDS IS NOT NULL
          AND UPPER(KEYWORDS) LIKE '%' || UPPER(#{keyword}) || '%'
        ORDER BY NEWS_DATE DESC
    </select>

    <!-- ‚úÖ ÌÇ§ÏõåÎìúÎ≥Ñ Ï¢ÖÎ™© Ï°∞Ìöå (Ï§ëÎ≥µ Ï†úÍ±∞, Îâ¥Ïä§ Í∞úÏàò Ìè¨Ìï®) -->
    <select id="getStocksByKeyword" resultType="map">
        SELECT 
            s.STOCK_CODE,
            s.STOCK_NAME,
            s.MARKET_TYPE,
            s.INDUSTRY,
            s.PRICE,
            s.PRICE_CHANGE,
            s.CHANGE_RATE,
            s.MARKET_CAP,
            COUNT(n.NEWS_ID) AS newsCount
        FROM STOCK_INFO s
        INNER JOIN STOCK_NEWS n ON s.STOCK_CODE = n.STOCK_CODE
        WHERE n.KEYWORDS IS NOT NULL
          AND UPPER(n.KEYWORDS) LIKE '%' || UPPER(#{keyword}) || '%'
        GROUP BY s.STOCK_CODE, s.STOCK_NAME, s.MARKET_TYPE, s.INDUSTRY, 
                 s.PRICE, s.PRICE_CHANGE, s.CHANGE_RATE, s.MARKET_CAP
        ORDER BY newsCount DESC, s.STOCK_NAME
    </select>

	<!-- üî• Ïù∏Í∏∞ Ï¢ÖÎ™© Top10 (Í∏∞ÏÇ¨ Ïàò Í∏∞Ï§Ä) -->
    <select id="getTop10PopularStocks" resultType="map">
        <![CDATA[
        SELECT *
        FROM (
            SELECT 
                N.STOCK_CODE,
                I.STOCK_NAME,
                COUNT(*) AS ARTICLE_COUNT
            FROM STOCK_NEWS N
            JOIN STOCK_INFO I 
                ON N.STOCK_CODE = I.STOCK_CODE
            GROUP BY N.STOCK_CODE, I.STOCK_NAME
            ORDER BY COUNT(*) DESC
        )
        WHERE ROWNUM <= 10
    ]]>
    
    </select>
</mapper>
